{"ast":null,"code":"import _assign from \"lodash/assign\";\nimport fullCalendarDefaultOptions from \"../fullcalendar\";\nimport { contextualMenuSelector } from \"../../components/SchedulesEditor/ContextualMenu\";\nimport { commonActivityCodes } from \"../../components/SchedulesEditor/CustomActivity\";\nimport { dropAreaMouseMoveHandler, dropAreaSelector, isEventOverDropArea } from \"../../components/SchedulesEditor/DropArea\";\nimport { addActivityToCalendar, dataToFcEvent, eventModifiedInCalendar, fcEventToActivity, removeEventFromCalendar, singleSelectEvent } from \"../utils/calendar\";\nimport { newActivityId, defaultDurationFromActivityCode } from \"../utils/edit-schedule\";\nimport { scheduleElementSelector } from \"./edit-schedule\";\nvar fullCalendarHandlers = {\n  onReceive: function onReceive(ev) {\n    var event = ev;\n    // Fix the default duration\n    var newEnd = event.start.clone();\n    newEnd.add(defaultDurationFromActivityCode(event.activityCode), 'm');\n    event.end = newEnd;\n    // We need to modify the original 'event' referenced here, so we won't\n    // use 'dataToFcEvent'.\n    // Set event title\n    event.title = event.name;\n    // Generate a new id\n    event.id = newActivityId();\n    // Add the event to the calendar (and to the WCIF schedule, but don't\n    // render it as it's already done)\n    addActivityToCalendar(fcEventToActivity(event), false);\n    singleSelectEvent(event);\n  },\n  onDragStart: function onDragStart() {\n    // Visually remove any selected event\n    $('.selected-fc-event').removeClass('selected-fc-event');\n    $(contextualMenuSelector).addClass('hide-element');\n    $(window).on('mousemove', dropAreaMouseMoveHandler);\n  },\n  onDragStop: function onDragStop(event, jsEvent) {\n    $(dropAreaSelector).removeClass('event-on-top');\n    $(window).off('mousemove', dropAreaMouseMoveHandler);\n    var removed = false;\n    if (isEventOverDropArea(jsEvent)) {\n      removed = removeEventFromCalendar(event);\n    }\n    if (!removed) {\n      // Drag stop outside the drop area makes the event render without the selected-fc-event class\n      singleSelectEvent(event);\n    }\n  },\n  onMoved: eventModifiedInCalendar,\n  onClick: function onClick(event, jsEvent) {\n    var $menu = $(contextualMenuSelector);\n    $menu.removeClass('delete-only');\n    // See https://github.com/fullcalendar/fullcalendar/issues/3324\n    // We can't use a context menu without running into this bug, so instead we use shift+click\n    if (jsEvent.which === 1 && jsEvent.shiftKey) {\n      $menu.data('event', event);\n      if (!event.activityCode.startsWith('other-')) {\n        $menu.addClass('delete-only');\n      }\n      $menu.removeClass('hide-element');\n      $menu.position({\n        my: 'left top',\n        of: jsEvent\n      });\n      // avoid it being immediately hidden by our window click listener\n      jsEvent.stopPropagation();\n    } else {\n      $menu.addClass('hide-element');\n    }\n    singleSelectEvent(event);\n  },\n  onResizeStart: function onResizeStart() {\n    // Visually remove any selected event\n    $('.selected-fc-event').removeClass('selected-fc-event');\n    $(contextualMenuSelector).addClass('hide-element');\n  },\n  // Now that resizing is done, it's safe to actually update FC's internals\n  onResizeStop: function onResizeStop(event) {\n    return singleSelectEvent(event);\n  },\n  onSizeChanged: eventModifiedInCalendar,\n  onTimeframeSelected: function onTimeframeSelected(showModalAction, start, end) {\n    var eventProps = {\n      title: commonActivityCodes['other-checkin'],\n      activityCode: 'other-checkin',\n      start: start,\n      end: end\n    };\n    showModalAction(eventProps, 'create');\n  }\n};\nexport default function generate(eventFetcher, showModalAction, scheduleWcif, additionalOptions) {\n  var options = fullCalendarDefaultOptions(scheduleWcif.startDate, scheduleWcif.numberOfDays);\n  _assign(options, additionalOptions);\n  var localOptions = {\n    // Having only one view for edition enable us to have a \"static\" list of event\n    // If we had more, we would need a function to fetch them every time\n    events: eventFetcher,\n    editable: true,\n    droppable: true,\n    selectable: true,\n    dragRevertDuration: 0,\n    eventDataTransform: dataToFcEvent,\n    eventReceive: fullCalendarHandlers.onReceive,\n    eventDragStart: fullCalendarHandlers.onDragStart,\n    eventDragStop: fullCalendarHandlers.onDragStop,\n    eventDrop: fullCalendarHandlers.onMoved,\n    eventClick: fullCalendarHandlers.onClick,\n    eventAfterRender: function eventAfterRender(event, element) {\n      if (event.selected) {\n        element.addClass('selected-fc-event');\n        // FC automatically add a border color in the \"style\" attribute based on the event color :(\n        // I couldn't find a way around it, so the simpler is to simply reset it here.\n        element.css('border-color', '');\n      }\n    },\n    eventResizeStart: fullCalendarHandlers.onResizeStart,\n    eventResizeStop: fullCalendarHandlers.onResizeStop,\n    eventResize: fullCalendarHandlers.onSizeChanged,\n    // We need to set selectMinDistance greater than 0 to suppress `select`\n    // events when the user simply single clicks (and does not drag) on the\n    // calendar. See https://fullcalendar.io/docs/selectMinDistance.\n    // I have no idea why this isn't the default behavior.\n    selectMinDistance: 5,\n    select: function select(start, end) {\n      return fullCalendarHandlers.onTimeframeSelected(showModalAction, start, end);\n    },\n    dayClick: function dayClick(date) {\n      return fullCalendarHandlers.onTimeframeSelected(showModalAction, date, date.clone().add(window.moment.duration(options.defaultTimedEventDuration)));\n    }\n  };\n  _assign(options, localOptions);\n  $(scheduleElementSelector).fullCalendar(options);\n}","map":{"version":3,"names":["fullCalendarDefaultOptions","contextualMenuSelector","commonActivityCodes","dropAreaMouseMoveHandler","dropAreaSelector","isEventOverDropArea","addActivityToCalendar","dataToFcEvent","eventModifiedInCalendar","fcEventToActivity","removeEventFromCalendar","singleSelectEvent","newActivityId","defaultDurationFromActivityCode","scheduleElementSelector","fullCalendarHandlers","onReceive","ev","event","newEnd","start","clone","add","activityCode","end","title","name","id","onDragStart","$","removeClass","addClass","window","on","onDragStop","jsEvent","off","removed","onMoved","onClick","$menu","which","shiftKey","data","startsWith","position","my","of","stopPropagation","onResizeStart","onResizeStop","onSizeChanged","onTimeframeSelected","showModalAction","eventProps","generate","eventFetcher","scheduleWcif","additionalOptions","options","startDate","numberOfDays","_assign","localOptions","events","editable","droppable","selectable","dragRevertDuration","eventDataTransform","eventReceive","eventDragStart","eventDragStop","eventDrop","eventClick","eventAfterRender","element","selected","css","eventResizeStart","eventResizeStop","eventResize","selectMinDistance","select","dayClick","date","moment","duration","defaultTimedEventDuration","fullCalendar"],"sources":["/app/WcaOnRails/app/webpacker/lib/helpers/fullcalendar.js"],"sourcesContent":["import _ from 'lodash';\n\nimport fullCalendarDefaultOptions from '../fullcalendar';\nimport { contextualMenuSelector } from '../../components/SchedulesEditor/ContextualMenu';\nimport { commonActivityCodes } from '../../components/SchedulesEditor/CustomActivity';\nimport { dropAreaMouseMoveHandler, dropAreaSelector, isEventOverDropArea } from '../../components/SchedulesEditor/DropArea';\nimport {\n  addActivityToCalendar,\n  dataToFcEvent,\n  eventModifiedInCalendar,\n  fcEventToActivity,\n  removeEventFromCalendar,\n  singleSelectEvent,\n} from '../utils/calendar';\nimport { newActivityId, defaultDurationFromActivityCode } from '../utils/edit-schedule';\nimport { scheduleElementSelector } from './edit-schedule';\n\nconst fullCalendarHandlers = {\n  onReceive: (ev) => {\n    const event = ev;\n    // Fix the default duration\n    const newEnd = event.start.clone();\n    newEnd.add(defaultDurationFromActivityCode(event.activityCode), 'm');\n    event.end = newEnd;\n    // We need to modify the original 'event' referenced here, so we won't\n    // use 'dataToFcEvent'.\n    // Set event title\n    event.title = event.name;\n    // Generate a new id\n    event.id = newActivityId();\n    // Add the event to the calendar (and to the WCIF schedule, but don't\n    // render it as it's already done)\n    addActivityToCalendar(fcEventToActivity(event), false);\n    singleSelectEvent(event);\n  },\n  onDragStart: () => {\n    // Visually remove any selected event\n    $('.selected-fc-event').removeClass('selected-fc-event');\n    $(contextualMenuSelector).addClass('hide-element');\n    $(window).on('mousemove', dropAreaMouseMoveHandler);\n  },\n  onDragStop: (event, jsEvent) => {\n    $(dropAreaSelector).removeClass('event-on-top');\n    $(window).off('mousemove', dropAreaMouseMoveHandler);\n    let removed = false;\n    if (isEventOverDropArea(jsEvent)) {\n      removed = removeEventFromCalendar(event);\n    }\n    if (!removed) {\n      // Drag stop outside the drop area makes the event render without the selected-fc-event class\n      singleSelectEvent(event);\n    }\n  },\n  onMoved: eventModifiedInCalendar,\n  onClick: (event, jsEvent) => {\n    const $menu = $(contextualMenuSelector);\n    $menu.removeClass('delete-only');\n    // See https://github.com/fullcalendar/fullcalendar/issues/3324\n    // We can't use a context menu without running into this bug, so instead we use shift+click\n    if (jsEvent.which === 1 && jsEvent.shiftKey) {\n      $menu.data('event', event);\n      if (!event.activityCode.startsWith('other-')) {\n        $menu.addClass('delete-only');\n      }\n      $menu.removeClass('hide-element');\n      $menu.position({ my: 'left top', of: jsEvent });\n      // avoid it being immediately hidden by our window click listener\n      jsEvent.stopPropagation();\n    } else {\n      $menu.addClass('hide-element');\n    }\n    singleSelectEvent(event);\n  },\n  onResizeStart: () => {\n    // Visually remove any selected event\n    $('.selected-fc-event').removeClass('selected-fc-event');\n    $(contextualMenuSelector).addClass('hide-element');\n  },\n  // Now that resizing is done, it's safe to actually update FC's internals\n  onResizeStop: (event) => singleSelectEvent(event),\n  onSizeChanged: eventModifiedInCalendar,\n  onTimeframeSelected: (showModalAction, start, end) => {\n    const eventProps = {\n      title: commonActivityCodes['other-checkin'],\n      activityCode: 'other-checkin',\n      start,\n      end,\n    };\n    showModalAction(eventProps, 'create');\n  },\n};\n\nexport default function generate(eventFetcher, showModalAction, scheduleWcif, additionalOptions) {\n  const options = fullCalendarDefaultOptions(scheduleWcif.startDate, scheduleWcif.numberOfDays);\n  _.assign(options, additionalOptions);\n\n  const localOptions = {\n    // Having only one view for edition enable us to have a \"static\" list of event\n    // If we had more, we would need a function to fetch them every time\n    events: eventFetcher,\n    editable: true,\n    droppable: true,\n    selectable: true,\n    dragRevertDuration: 0,\n    eventDataTransform: dataToFcEvent,\n    eventReceive: fullCalendarHandlers.onReceive,\n    eventDragStart: fullCalendarHandlers.onDragStart,\n    eventDragStop: fullCalendarHandlers.onDragStop,\n    eventDrop: fullCalendarHandlers.onMoved,\n    eventClick: fullCalendarHandlers.onClick,\n    eventAfterRender: (event, element) => {\n      if (event.selected) {\n        element.addClass('selected-fc-event');\n        // FC automatically add a border color in the \"style\" attribute based on the event color :(\n        // I couldn't find a way around it, so the simpler is to simply reset it here.\n        element.css('border-color', '');\n      }\n    },\n    eventResizeStart: fullCalendarHandlers.onResizeStart,\n    eventResizeStop: fullCalendarHandlers.onResizeStop,\n    eventResize: fullCalendarHandlers.onSizeChanged,\n\n    // We need to set selectMinDistance greater than 0 to suppress `select`\n    // events when the user simply single clicks (and does not drag) on the\n    // calendar. See https://fullcalendar.io/docs/selectMinDistance.\n    // I have no idea why this isn't the default behavior.\n    selectMinDistance: 5,\n    select: (start, end) => fullCalendarHandlers.onTimeframeSelected(showModalAction, start, end),\n    dayClick: (date) => fullCalendarHandlers.onTimeframeSelected(\n      showModalAction,\n      date,\n      date.clone().add(window.moment.duration(options.defaultTimedEventDuration)),\n    ),\n  };\n\n  _.assign(options, localOptions);\n  $(scheduleElementSelector).fullCalendar(options);\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}